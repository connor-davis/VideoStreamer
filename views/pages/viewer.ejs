<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head'); %>
</head>

<body class="flex flex-col w-screen h-screen bg-gray-100">
    <div class="flex flex-col w-full h-full justify-center items-center">
        <div class="flex flex-col space-y-10 justify-center bg-white rounded-md shadow-lg shadow-gray-300 p-5" id="viewerWelcomeScreen">
            <div class="flex flex-col space-y-2">
                <h1 class="flex flex-col w-full h-full justify-center items-center text-gray-900 text-9xl font-bold md:text-2xl">Welcome Viewer</h1>
                <div class="text-center text-gray-400">Please enter the session id to join.</div>
            </div>

            <div class="flex flex-col justify-center space-y-4">
                <input type="text" class="flex space-x-3 justify-center items-center w-full border-none h-auto p-2 bg-gray-300 rounded-md outline-none" name="sessionIdInput" id="sessionIdInput" placeholder="Session ID">

                <div class="w-full h-auto bg-blue-500 text-white shadow-lg shadow-blue-500 py-3 px-4 rounded-md text-center cursor-pointer" onclick={joinSession()}>Join Session</div>
                <input type="file" name="fileInput" id="fileInput" class="hidden">
            </div>
        </div>

        <div class="flex-col w-full h-full items-center bg-black hidden" id="viewerVideoScreen">
            <video id="videoPlayer" class="w-full h-full" onclick="toggleNavBar()"></video>
            <div class="absolute flex space-x-5 items-center left-5 right-5 bottom-5 h-auto p-5 bg-transparent rounded-md" id="viewerNavBar">
                <div class="flex w-auto h-full space-x-2">
                    <div class="fill-blue-500 cursor-pointer" onclick="playVideo()" id="playVideoButton">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="Layer_1" style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" xml:space="preserve" class="w-6 h-6">
                            <path d="M405.2,232.9L126.8,67.2c-3.4-2-6.9-3.2-10.9-3.2c-10.9,0-19.8,9-19.8,20H96v344h0.1c0,11,8.9,20,19.8,20  c4.1,0,7.5-1.4,11.2-3.4l278.1-165.5c6.6-5.5,10.8-13.8,10.8-23.1C416,246.7,411.8,238.5,405.2,232.9z" />
                        </svg>
                    </div>
                    <div class="fill-blue-500 cursor-pointer hidden" onclick="pauseVideo()" id="pauseVideoButton">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="Layer_1" style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" class="w-6 h-6" xml:space="preserve">
                            <g>
                                <path d="M224,435.8V76.1c0-6.7-5.4-12.1-12.2-12.1h-71.6c-6.8,0-12.2,5.4-12.2,12.1v359.7c0,6.7,5.4,12.2,12.2,12.2h71.6   C218.6,448,224,442.6,224,435.8z" />
                                <path d="M371.8,64h-71.6c-6.7,0-12.2,5.4-12.2,12.1v359.7c0,6.7,5.4,12.2,12.2,12.2h71.6c6.7,0,12.2-5.4,12.2-12.2V76.1   C384,69.4,378.6,64,371.8,64z" />
                            </g>
                        </svg>
                    </div>
                </div>
                <div class="relative flex w-full h-2 bg-gray-300 rounded-md" id="progressBar">
                    <div class="bg-blue-500 rounded-md h-2 absolute left-0 bottom-0 top-0" id="progressBarTrack"></div>
                </div>
                <div class="flex w-auto h-full space-x-2">
                    <div class="fill-blue-500 cursor-pointer" onclick="openFullscreen()" id="openFullscreenButton">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 14 14" class="h-6 w-6 fill-blue-500">
                            <title />
                            <desc />
                            <defs />
                            <g id="Page-1" stroke="none" stroke-width="1">
                                <g id="Core" transform="translate(-215.000000, -257.000000)">
                                    <g id="fullscreen" transform="translate(215.000000, 257.000000)">
                                        <path d="M2,9 L0,9 L0,14 L5,14 L5,12 L2,12 L2,9 L2,9 Z M0,5 L2,5 L2,2 L5,2 L5,0 L0,0 L0,5 L0,5 Z M12,12 L9,12 L9,14 L14,14 L14,9 L12,9 L12,12 L12,12 Z M9,0 L9,2 L12,2 L12,5 L14,5 L14,0 L9,0 L9,0 Z"
                                            id="Shape" />
                                    </g>
                                </g>
                            </g>
                        </svg>
                    </div>
                    <div class="fill-blue-500 cursor-pointer hidden" onclick="closeFullscreen()" id="closeFullscreenButton">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96" class="h-6 w-6">
                            <title />
                            <g>
                                <path d="M30,60H6A6,6,0,0,0,6,72H24V90a6,6,0,0,0,12,0V66A5.9966,5.9966,0,0,0,30,60Z" />
                                <path d="M90,60H66a5.9966,5.9966,0,0,0-6,6V90a6,6,0,0,0,12,0V72H90a6,6,0,0,0,0-12Z" />
                                <path d="M66,36H90a6,6,0,0,0,0-12H72V6A6,6,0,0,0,60,6V30A5.9966,5.9966,0,0,0,66,36Z" />
                                <path d="M30,0a5.9966,5.9966,0,0,0-6,6V24H6A6,6,0,0,0,6,36H30a5.9966,5.9966,0,0,0,6-6V6A5.9966,5.9966,0,0,0,30,0Z" />
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let viewerWelcomeScreen = document.getElementById("viewerWelcomeScreen");
        let viewerVideoScreen = document.getElementById("viewerVideoScreen");
        let viewerNavBar = document.getElementById("viewerNavBar");
        let playVideoButton = document.getElementById("playVideoButton");
        let pauseVideoButton = document.getElementById("pauseVideoButton");
        let videoPlayer = document.getElementById("videoPlayer");
        let videoSelector = document.getElementById("videoSelector");
        let progressBar = document.getElementById("progressBar");
        let progressBarTrack = document.getElementById("progressBarTrack");
        let sessionIdInput = document.getElementById("sessionIdInput");

        let socket = io();

        let toggleNavBar = () => {
            viewerNavBar.classList.toggle("hidden");
        }

        let playVideo = () => {
            if (videoPlayer.isPaused) videoPlayer.play();

            playVideoButton.classList.add("hidden");
            pauseVideoButton.classList.remove("hidden");

            socket.emit(socket.sessionId, { event: "play-video" });

            viewerNavBar.classList.add("hidden");
        }

        let pauseVideo = () => {
            if (!videoPlayer.isPaused) videoPlayer.pause();

            pauseVideoButton.classList.add("hidden");
            playVideoButton.classList.remove("hidden");

            socket.emit(socket.sessionId, { event: "pause-video" });

            viewerNavBar.classList.add("hidden");
        }

        let fullscreenElement = document.documentElement;

        let openFullscreen = () => {
            openFullscreenButton.classList.add("hidden");
            closeFullscreenButton.classList.remove("hidden");

            fullscreenElement.requestFullscreen();
        }

        let closeFullscreen = () => {
            closeFullscreenButton.classList.add("hidden");
            openFullscreenButton.classList.remove("hidden");

            document.exitFullscreen();
        }

        let syncTime = () => {
            socket.emit(socket.sessionId, { event: "time-change", time: videoPlayer.currentTime });
        }

        let joinSession = () => {
            socket.emit("joinSession", sessionIdInput.value);

            socket.sessionId = sessionIdInput.value;

            socket.on(sessionIdInput.value, (packet) => {
                console.log(packet);

                if (packet.event) {
                    let event = packet.event;

                    switch (event) {
                        case "joined-session":
                            videoPlayer.src = "/video/" + packet.videoId;
                            videoPlayer.load();

                            videoPlayer.addEventListener("progress", (event) => {
                                let progress = Math.floor(((videoPlayer.currentTime / videoPlayer.duration) * 100));

                                progressBarTrack.style.width = progress + "%";
                            });

                            viewerWelcomeScreen.classList.add("hidden");
                            viewerVideoScreen.classList.remove("hidden");

                            videoPlayer.addEventListener("play", () => playVideo());
                            videoPlayer.addEventListener("pause", () => pauseVideo());

                            syncTime();

                            break;

                        case "play-video":
                            videoPlayer.currentTime = packet.time;
                            videoPlayer.play();

                            playVideoButton.classList.add("hidden");
                            pauseVideoButton.classList.remove("hidden");

                            viewerNavBar.classList.add("hidden");

                            break;

                        case "pause-video":
                            videoPlayer.currentTime = packet.time;
                            videoPlayer.pause();

                            pauseVideoButton.classList.add("hidden");
                            playVideoButton.classList.remove("hidden");

                            viewerNavBar.classList.add("hidden");

                            break;

                        case "time-changed":
                            videoPlayer.pause();
                            videoPlayer.currentTime = packet.time;
                            videoPlayer.play();

                            break;

                        default:
                            break;
                    }
                }
            });
        }
    </script>
</body>

</html>